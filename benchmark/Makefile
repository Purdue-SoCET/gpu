# --- Variables ---

# CPU Compiler and flags
CPU_CC = gcc
CPU_CFLAGS = -DCPU_SIM -Wall -Wextra -g
CPU_LDFLAGS = -lm

GPU_CC = python3 ../../gpu-ppci-compiler/compile_twig.py
GPU_CFLAGS = 

# Larger project CPU kernel files
CPU_SRCS = cpu_sim/main.c cpu_sim/kernel_run.c kernels/graphics_lib.c \
       kernels/vertexShader.c kernels/triangle.c kernels/pixel.c
CPU_BUILD_DIR = build/
CPU_OUTPUT_DIR = $(CPU_BUILD_DIR)output/
CPU_TARGET = cpu_sim.out
CPU_PPM = frame_000.ppm

# --- Targets ---

# Default
all: output.png

run: $(CPU_PPM)

$(CPU_TARGET): $(SRCS)
 	# Make build dir if it does not exist
	mkdir -p $(CPU_BUILD_DIR)
	mkdir -p $(CPU_OUTPUT_DIR)
	$(CPU_CC) $(CPU_CFLAGS) -o $(CPU_BUILD_DIR)$(CPU_TARGET) $(CPU_SRCS) $(CPU_LDFLAGS)

$(CPU_PPM): $(CPU_TARGET)
	./$(CPU_BUILD_DIR)$(CPU_TARGET)

output.png: $(CPU_PPM)
	ffmpeg -y -loglevel error -i $(CPU_OUTPUT_DIR)$(CPU_PPM) $(CPU_BUILD_DIR)output.png

# Rule to clean up all generated files
clean:
	rm -rf $(CPU_BUILD_DIR)*

# Tell 'make' that 'all', 'run', and 'clean' are not files
.PHONY: all run clean